#!/usr/bin/env node

var mongoose = require('mongoose');
var Promise = require('bluebird');

var elastic = require('../../utils/elasticSearch');
var log = require('../../utils/logger').logger;

var glossaryMap = {};

var testElasticConnection = function () {
	return elastic.ping()
	.then( function () {
		log.info('ElasticSearch connection established...');
	})
	.catch( function (err) {
		log.error('Failed to establish ElasticSearch Connection');
		process.exit(0);
	});
};

var reindexGlossary = function (gloss) {
	glossaryMap[gloss._id.toString()] = true;

	if (gloss.entries.length < 1) {
		log.info(`Skipping Glossary ${gloss._id} because it contains no entries`);
		return Promise.resolve(true);
	}

	log.info(`Reindexing Glossary ${gloss._id}...`);

	return elastic.deleteGlossaryIndex(gloss._id)
	.catch( function (err) {
		log.warn('Index did not previously exist');
		if (err.body.error.reason == 'no such index') {

			return true;
		}

		throw err;
	})
	.then( function () {
		return Promise.mapSeries(gloss.entries, function (entry) {
			return elastic.indexEntry(entry, gloss._id);
		})
	})
	.then( function () {
		log.verbose(`Re-indexed ${gloss.entries.length} entries from Glossary ${gloss._id}`);
	});
};


// Initialize mongo/mongoose connection and models
var db = require('../../db').init({performCheck: false})
.then( function () {
	// initialize elastic connection
	return testElasticConnection();
})
.then( function () {
    var Glossary = mongoose.model('Glossary');

    // Get all Glossary Docs with entries references populated
    return Glossary.find({}).populate([
        {
            path: 'entries',
            model: 'Entry'
            // no need to populate Terms, the Elastic util/interface does that for us
        }
    ]).exec()
        .then(function (glossaryDocs) {
            return Promise.mapSeries(glossaryDocs, reindexGlossary);
        })
        .then(function () {
            // query elastic for all indices
            elastic.getIndices()
			.then(function (indices) {
				return Promise.mapSeries(Object.keys(indices), function (indexName) {
                    if (indexName.includes("kt_")) {
                        indexName = indexName.slice(3);
                        if (!(indexName in glossaryMap)) {
                            //var temp = index.split("_")[1];
                            return elastic.deleteGlossaryIndex(indexName);
                        }
                    }
                });
			});
            // .then => iterate over the list and check if the glossary exists in the glossaryMap
            // if ( ! (id in glossaryMap) ) {}
            //		if not, delete the index
        })
})
.catch( function (err) {
	console.log(err);
	process.exit(0);
})
.then( function (gloss) {
	log.info('Re-indexing completed.');
	mongoose.disconnect();
});
